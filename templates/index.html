<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TodoList</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 600px;
            margin: 2rem auto;
            padding: 1.5rem;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 1.5rem;
        }
        
        .add-form {
            display: flex;
            flex-direction: column;
            margin-bottom: 1.5rem;
            gap: 0.75rem;
        }
        
        .add-form input[type="text"] {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .deadline-input {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .deadline-input label {
            font-weight: 500;
            color: #555;
        }
        
        .deadline-input input[type="datetime-local"] {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .todo-deadline {
            font-size: 0.85rem;
            color: #666;
            margin-top: 0.25rem;
        }
        
        .todo-deadline.overdue {
            color: #e74c3c;
            font-weight: 500;
        }
        
        .todo-deadline.upcoming {
            color: #f39c12;
        }
        
        .todo-deadline.normal {
            color: #27ae60;
        }
        
        .add-form button {
            padding: 0.75rem 1.5rem;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }
        
        .add-form button:hover {
            background-color: #2980b9;
        }
        
        .todo-list {
            list-style: none;
        }
        
        .todo-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            margin-bottom: 0.5rem;
            background-color: #fafafa;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .todo-item:hover {
            background-color: #f0f0f0;
        }
        
        .todo-item.completed {
            background-color: #e8f5e8;
        }
        
        .todo-item.completed .todo-title {
            text-decoration: line-through;
            color: #888;
        }
        
        .todo-checkbox {
            margin-right: 1rem;
            transform: scale(1.2);
        }
        
        .todo-title {
            flex: 1;
            font-size: 1rem;
        }
        
        .todo-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .btn-delete {
            background-color: #e74c3c;
            color: white;
        }
        
        .btn-delete:hover {
            background-color: #c0392b;
        }
        
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: #888;
            font-style: italic;
        }
        
        /* å‘¨æœŸè®¾ç½®æ ·å¼ */
        .recurrence-section {
            margin-top: 10px;
        }
        
        .recurrence-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .recurrence-row {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .recurrence-days {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 5px;
        }
        
        .recurrence-days label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }
        
        .recurrence-settings {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }
        
        /* å‘¨æœŸäº‹é¡¹åˆ—è¡¨æ˜¾ç¤º */
        .todo-item.recurring {
            border-left: 4px solid #3498db;
        }
        
        .todo-recurrence {
            font-size: 0.85rem;
            color: #666;
            margin-top: 0.25rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .todo-recurrence::before {
            content: 'ğŸ”„';
        }
        
        .todo-next-occurrence {
            font-size: 0.8rem;
            color: #27ae60;
            margin-top: 0.25rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>TodoList</h1>
        
        <form class="add-form" action="/add" method="post">
            <input type="text" name="title" placeholder="æ·»åŠ æ–°çš„å¾…åŠäº‹é¡¹..." required>
            <div class="deadline-input">
                <label for="deadline">æˆªæ­¢æ—¶é—´ï¼š</label>
                <input type="datetime-local" id="deadline" name="deadline" required>
            </div>
            
            <!-- å‘¨æœŸè®¾ç½® -->
            <div class="recurrence-section">
                <div class="recurrence-toggle">
                    <input type="checkbox" id="is_recurring" name="is_recurring">
                    <label for="is_recurring">è®¾ç½®ä¸ºå‘¨æœŸäº‹é¡¹</label>
                </div>
                
                <div class="recurrence-settings" style="display: none; margin-left: 20px; margin-top: 10px;">
                    <div class="recurrence-row">
                        <label for="recurrence_type">å‘¨æœŸç±»å‹ï¼š</label>
                        <select id="recurrence_type" name="recurrence_type">
                            <option value="yearly">æ¯nå¹´</option>
                            <option value="monthly">æ¯næœˆ</option>
                            <option value="daily">æ¯næ—¥</option>
                            <option value="hourly">æ¯nå°æ—¶</option>
                            <option value="minutely">æ¯nåˆ†é’Ÿ</option>
                            <option value="weekly" selected>æ¯å‘¨n</option>
                        </select>
                    </div>
                    
                    <div class="recurrence-row">
                        <label for="recurrence_interval">å‘¨æœŸé—´éš”ï¼š</label>
                        <input type="number" id="recurrence_interval" name="recurrence_interval" min="1" value="1">
                        <span id="interval-unit">å‘¨</span>
                    </div>
                    
                    <!-- æ¯å‘¨ç‰¹å®šæ—¥é€‰æ‹© -->
                    <div class="recurrence-days-section" style="margin-top: 10px;">
                        <label>æ¯å‘¨ç‰¹å®šæ—¥ï¼š</label>
                        <div class="recurrence-days">
                            <label><input type="checkbox" name="recurrence_days_checkbox" value="0">å‘¨ä¸€</label>
                            <label><input type="checkbox" name="recurrence_days_checkbox" value="1">å‘¨äºŒ</label>
                            <label><input type="checkbox" name="recurrence_days_checkbox" value="2">å‘¨ä¸‰</label>
                            <label><input type="checkbox" name="recurrence_days_checkbox" value="3">å‘¨å››</label>
                            <label><input type="checkbox" name="recurrence_days_checkbox" value="4">å‘¨äº”</label>
                            <label><input type="checkbox" name="recurrence_days_checkbox" value="5">å‘¨å…­</label>
                            <label><input type="checkbox" name="recurrence_days_checkbox" value="6">å‘¨æ—¥</label>
                        </div>
                    </div>
                    
                    <!-- éšè—çš„å­—æ®µï¼Œç”¨äºå­˜å‚¨é€‰ä¸­çš„æ¯å‘¨ç‰¹å®šæ—¥ï¼ˆJSONæ ¼å¼ï¼‰ -->
                    <input type="hidden" id="recurrence_days_json" name="recurrence_days">
                </div>
            </div>
            
            <button type="submit">æ·»åŠ </button>
        </form>
        <!-- æ‰¹é‡æ“ä½œæŒ‰é’® -->
        <div class="batch-actions">
            <div style="display: flex; align-items: center;">
                <input type="checkbox" id="select-all" style="margin-right: 0.5rem;">
                <label for="select-all">å…¨é€‰</label>
            </div>
            <button id="select-completed" class="btn">é€‰ä¸­å·²å®Œæˆ</button>
            <button id="delete-selected" class="btn btn-delete">åˆ é™¤é€‰ä¸­</button>
        </div>

        <form id="batch-delete-form" action="/batch-delete" method="post" style="display: none;">
            <input type="hidden" id="selected-todos" name="todo_ids">
        </form>
        
        <ul class="todo-list">
            {% if todos %}
                {% for todo in todos %}
                <li id="todo-{{ todo[0] }}" class="todo-item {% if todo[2] %}completed{% endif %} {% if todo[4] %}recurring{% endif %}">
                    {% if todo[0] > 0 %}
                    <input type="checkbox" class="item-checkbox" data-id="{{ todo[0] }}" style="margin-right: 1rem; transform: scale(1.2);">
                    {% endif %}
                    {% if todo[0] > 0 %}
                    <form action="/toggle/{{ todo[0] }}#todo-{{ todo[0] }}" method="post" class="toggle-form" style="display: inline;">
                        <input type="checkbox" class="todo-checkbox" {% if todo[2] %}checked{% endif %}>
                    </form>
                    {% else %}
                    <!-- å³å°†åˆ°æ¥çš„äº‹é¡¹ä¸å…è®¸ç›´æ¥æ“ä½œ -->
                    <input type="checkbox" class="todo-checkbox" disabled {% if todo[2] %}checked{% endif %} style="opacity: 0.5; cursor: not-allowed;">
                    {% endif %}
                    <div class="todo-content">
                        <span class="todo-title">{{ todo[1] }}</span>
                        <span class="todo-deadline" data-deadline="{{ todo[3] }}">
                            æˆªæ­¢æ—¶é—´ï¼š{{ todo[3] }}
                        </span>
                        
                        <!-- æ˜¾ç¤ºå‘¨æœŸä¿¡æ¯ -->
                        {% if todo[4] %}
                        <span class="todo-recurrence">
                            {{ 'æ¯' }}{{ todo[6] }}{% if todo[5] == 'yearly' %}å¹´{% elif todo[5] == 'monthly' %}æœˆ{% elif todo[5] == 'daily' %}æ—¥{% elif todo[5] == 'hourly' %}å°æ—¶{% elif todo[5] == 'minutely' %}åˆ†é’Ÿ{% elif todo[5] == 'weekly' %}å‘¨{% endif %}
                            {% if todo[5] == 'weekly' and todo[7] %}
                                {% set days = [] %}
                                {% if todo[7] %}
                                    {% if todo[7] is string %}
                                        {% set days = todo[7]|fromjson %}
                                    {% elif todo[7] is iterable and todo[7] is not string %}
                                        {% set days = todo[7] %}
                                    {% else %}
                                        {% set days = [todo[7]] %}
                                    {% endif %}
                                {% endif %}
                                {% if days %}
                                    {% for day in days %}
                                        {% if day == 0 %}ä¸€{% elif day == 1 %}äºŒ{% elif day == 2 %}ä¸‰{% elif day == 3 %}å››{% elif day == 4 %}äº”{% elif day == 5 %}å…­{% elif day == 6 %}æ—¥{% endif %}
                                    {% endfor %}
                                {% endif %}
                            {% endif %}
                        </span>
                        {% if todo[8] %}
                        <span class="todo-next-occurrence">
                            ä¸‹æ¬¡ï¼š{{ todo[8] }}
                        </span>
                        {% endif %}
                        {% endif %}
                    </div>
                    <div class="todo-actions">
                        {% if todo[0] > 0 %}
                        <button type="button" class="btn btn-delete" data-todo-id="{{ todo[0] }}" data-is-recurring="{{ 'true' if todo[4] else 'false' }}" data-original-id="{{ todo[0] // 1000000 if todo[4] else '' }}">åˆ é™¤</button>
                        {% endif %}
                    </div>
                </li>
                {% endfor %}
            {% else %}
                <li class="empty-state">è¿˜æ²¡æœ‰å¾…åŠäº‹é¡¹ï¼Œæ·»åŠ ä¸€ä¸ªå§ï¼</li>
            {% endif %}
        </ul>
    </div>
    
    <script>
        // è®¾ç½®é»˜è®¤æˆªæ­¢æ—¶é—´ä¸ºå½“å‰æ—¶é—´+24å°æ—¶
        document.addEventListener('DOMContentLoaded', function() {
            // è®¡ç®—24å°æ—¶åçš„æ—¶é—´
            const now = new Date();
            const tomorrow = new Date(now.getTime() + 24 * 60 * 60 * 1000);
            
            // æ ¼å¼åŒ–æ—¶é—´ä¸ºYYYY-MM-DDTHH:MMæ ¼å¼
            const year = tomorrow.getFullYear();
            const month = String(tomorrow.getMonth() + 1).padStart(2, '0');
            const day = String(tomorrow.getDate()).padStart(2, '0');
            const hours = String(tomorrow.getHours()).padStart(2, '0');
            const minutes = String(tomorrow.getMinutes()).padStart(2, '0');
            
            const formattedDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;
            
            // è®¾ç½®é»˜è®¤å€¼
            const deadlineInput = document.getElementById('deadline');
            if (deadlineInput) {
                deadlineInput.value = formattedDateTime;
            }
            
            // æ›´æ–°deadlineçŠ¶æ€æ ·å¼
            updateDeadlineStatus();
            // åˆå§‹åŒ–æ‰¹é‡æ“ä½œåŠŸèƒ½
            initBatchOperations();
        });
        
        // æ›´æ–°æ‰€æœ‰deadlineçŠ¶æ€æ ·å¼
        function updateDeadlineStatus() {
            const now = new Date();
            const deadlines = document.querySelectorAll('.todo-deadline');
            
            deadlines.forEach(deadlineEl => {
                const deadlineStr = deadlineEl.getAttribute('data-deadline');
                if (deadlineStr) {
                    const deadline = new Date(deadlineStr);
                    const diff = deadline - now;
                    
                    // ç§»é™¤æ‰€æœ‰çŠ¶æ€ç±»
                    deadlineEl.classList.remove('overdue', 'upcoming', 'normal');
                    
                    // æ·»åŠ çŠ¶æ€ç±»
                    if (diff < 0) {
                        deadlineEl.classList.add('overdue');
                        deadlineEl.textContent = `æˆªæ­¢æ—¶é—´ï¼š${deadlineStr} (å·²è¿‡æœŸ)`;
                    } else if (diff < 24 * 60 * 60 * 1000) {
                        deadlineEl.classList.add('upcoming');
                        deadlineEl.textContent = `æˆªæ­¢æ—¶é—´ï¼š${deadlineStr} (å³å°†è¿‡æœŸ)`;
                    } else {
                        deadlineEl.classList.add('normal');
                        deadlineEl.textContent = `æˆªæ­¢æ—¶é—´ï¼š${deadlineStr}`;
                    }
                }
            });
        }
        
        // æ‰¹é‡æ“ä½œåŠŸèƒ½åˆå§‹åŒ–
        function initBatchOperations() {
            const selectAllCheckbox = document.getElementById('select-all');
            const selectCompletedButton = document.getElementById('select-completed');
            const deleteSelectedButton = document.getElementById('delete-selected');
            const itemCheckboxes = document.querySelectorAll('.item-checkbox');
            const batchDeleteForm = document.getElementById('batch-delete-form');
            const selectedTodosInput = document.getElementById('selected-todos');
            
            // å…¨é€‰åŠŸèƒ½
            selectAllCheckbox.addEventListener('change', function() {
                const isChecked = this.checked;
                itemCheckboxes.forEach(checkbox => {
                    checkbox.checked = isChecked;
                });
            });
            
            // é€‰ä¸­å·²å®ŒæˆåŠŸèƒ½
            selectCompletedButton.addEventListener('click', function() {
                // å…ˆå–æ¶ˆå…¨é€‰
                selectAllCheckbox.checked = false;
                
                itemCheckboxes.forEach(checkbox => {
                    const todoItem = checkbox.closest('.todo-item');
                    if (todoItem && todoItem.classList.contains('completed')) {
                        checkbox.checked = true;
                    } else {
                        checkbox.checked = false;
                    }
                });
            });
            
            // åˆ é™¤é€‰ä¸­åŠŸèƒ½
            deleteSelectedButton.addEventListener('click', function() {
                const selectedItems = Array.from(itemCheckboxes)
                    .filter(checkbox => checkbox.checked);
                
                if (selectedItems.length === 0) {
                    alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„å¾…åŠäº‹é¡¹');
                    return;
                }
                
                // è·å–é€‰ä¸­çš„ID
                const selectedIds = selectedItems
                    .map(item => item.getAttribute('data-id'))
                    .filter(id => parseInt(id) > 0);
                
                // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
                if (confirm('ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„å¾…åŠäº‹é¡¹å—ï¼Ÿ')) {
                    // ä»…åˆ é™¤å½“å‰å®ä¾‹ï¼Œä¸ç®¡æ˜¯å‘¨æœŸè¿˜æ˜¯éå‘¨æœŸäº‹é¡¹
                    selectedTodosInput.value = JSON.stringify({todo_ids: selectedIds, delete_all: false});
                    batchDeleteForm.submit();
                }
            });
            
            // ä¸ºå¤é€‰æ¡†æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œæäº¤çˆ¶çº§è¡¨å•
        document.querySelectorAll('.todo-checkbox:not([disabled])').forEach(checkbox => {
            checkbox.addEventListener('click', function(e) {
                // è·å–çˆ¶çº§è¡¨å•å¹¶æäº¤
                const form = this.closest('.toggle-form');
                if (form) {
                    // å»¶è¿Ÿæäº¤è¡¨å•ï¼Œç¡®ä¿å¤é€‰æ¡†çŠ¶æ€å…ˆæ›´æ–°
                    setTimeout(() => {
                        form.submit();
                    }, 10);
                }
            });
        });
        }
        
        // ä¸ºåˆ é™¤æŒ‰é’®æ·»åŠ ç¡®è®¤æç¤ºå’Œé€»è¾‘å¤„ç†
        document.querySelectorAll('.btn-delete').forEach(button => {
            button.addEventListener('click', function(e) {
                // è·³è¿‡æ‰¹é‡åˆ é™¤æŒ‰é’®
                if (this.id === 'delete-selected') {
                    return;
                }
                
                e.preventDefault();
                const todoId = this.getAttribute('data-todo-id');
                const isRecurring = this.getAttribute('data-is-recurring') === 'true';
                const originalId = this.getAttribute('data-original-id');
                
                if (isRecurring) {
                    // åˆ›å»ºåŠé€æ˜èƒŒæ™¯é®ç½©
                    const overlay = document.createElement('div');
                    overlay.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background-color: rgba(0, 0, 0, 0.5);
                        z-index: 999;
                    `;
                    document.body.appendChild(overlay);
                    
                    // åˆ›å»ºè‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†
                    const dialog = document.createElement('div');
                    dialog.style.cssText = `
                        position: fixed;
                        top: 30%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: white;
                        border: 1px solid #ccc;
                        border-radius: 8px;
                        padding: 20px;
                        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
                        z-index: 1000;
                        font-family: Arial, sans-serif;
                        cursor: move;
                    `;
                    
                    const dialogContent = document.createElement('div');
                    dialogContent.innerHTML = `
                        <h3 style="margin-top: 0; margin-bottom: 15px; color: #333; cursor: default;">åˆ é™¤å‘¨æœŸäº‹é¡¹</h3>
                        <p style="margin-bottom: 20px; color: #555; cursor: default;">æ£€æµ‹åˆ°è¿™æ˜¯å‘¨æœŸäº‹é¡¹</p>
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button id="cancel-btn" style="
                                padding: 8px 16px;
                                background-color: #95a5a6;
                                color: white;
                                border: none;
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 14px;
                            ">å–æ¶ˆ</button>
                            <button id="delete-current-btn" style="
                                padding: 8px 16px;
                                background-color: #3498db;
                                color: white;
                                border: none;
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 14px;
                            ">ä»…åˆ é™¤å½“å‰</button>
                            <button id="delete-all-btn" style="
                                padding: 8px 16px;
                                background-color: #e74c3c;
                                color: white;
                                border: none;
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 14px;
                            ">åˆ é™¤å…¨éƒ¨</button>
                        </div>
                    `;
                    
                    dialog.appendChild(dialogContent);
                    document.body.appendChild(dialog);
                    
                    // æ·»åŠ æ‹–åŠ¨åŠŸèƒ½
                    let isDragging = false;
                    let startX, startY, startLeft, startTop;
                    
                    // é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶
                    dialog.addEventListener('mousedown', function(e) {
                        // åªæœ‰ç‚¹å‡»å¯¹è¯æ¡†æ ‡é¢˜æˆ–ç©ºç™½åŒºåŸŸæ‰èƒ½æ‹–åŠ¨
                        if (e.target.tagName === 'H3' || e.target === dialog || e.target === dialogContent) {
                            isDragging = true;
                            // è·å–é¼ æ ‡ç›¸å¯¹äºå¯¹è¯æ¡†çš„ä½ç½®
                            startX = e.clientX - dialog.offsetLeft;
                            startY = e.clientY - dialog.offsetTop;
                            // é˜»æ­¢é»˜è®¤è¡Œä¸º
                            e.preventDefault();
                        }
                    });
                    
                    // é¼ æ ‡ç§»åŠ¨äº‹ä»¶
                    document.addEventListener('mousemove', function(e) {
                        if (isDragging) {
                            // è®¡ç®—æ–°ä½ç½®
                            const newLeft = e.clientX - startX;
                            const newTop = e.clientY - startY;
                            // æ›´æ–°å¯¹è¯æ¡†ä½ç½®
                            dialog.style.left = newLeft + 'px';
                            dialog.style.top = newTop + 'px';
                            // ç§»é™¤transformå±æ€§ï¼Œé¿å…ä¸ç›´æ¥å®šä½å†²çª
                            dialog.style.transform = 'none';
                        }
                    });
                    
                    // é¼ æ ‡é‡Šæ”¾äº‹ä»¶
                    document.addEventListener('mouseup', function() {
                        isDragging = false;
                    });
                    
                    // ç‚¹å‡»é®ç½©å…³é—­å¯¹è¯æ¡†
                    overlay.addEventListener('click', function() {
                        document.body.removeChild(overlay);
                        document.body.removeChild(dialog);
                    });
                    
                    // å–æ¶ˆæŒ‰é’®äº‹ä»¶
                    dialogContent.querySelector('#cancel-btn').addEventListener('click', function() {
                        // ä»…å…³é—­å¯¹è¯æ¡†ï¼Œä¸æ‰§è¡Œä»»ä½•æ“ä½œ
                        document.body.removeChild(overlay);
                        document.body.removeChild(dialog);
                    });
                    
                    // ä»…åˆ é™¤å½“å‰æŒ‰é’®äº‹ä»¶
                    dialogContent.querySelector('#delete-current-btn').addEventListener('click', function() {
                        // åˆ é™¤å½“å‰å®ä¾‹
                        // æ„å»ºåˆ é™¤æ•°æ®
                        const deleteData = {
                            todo_ids: [parseInt(todoId)],
                            delete_all: false
                        };
                        
                        // æäº¤åˆ°æ‰¹é‡åˆ é™¤ç«¯ç‚¹
                        const batchDeleteForm = document.getElementById('batch-delete-form');
                        const selectedTodosInput = document.getElementById('selected-todos');
                        selectedTodosInput.value = JSON.stringify(deleteData);
                        batchDeleteForm.submit();
                        
                        // ç§»é™¤å¯¹è¯æ¡†å’Œé®ç½©
                        document.body.removeChild(overlay);
                        document.body.removeChild(dialog);
                    });
                    
                    // åˆ é™¤å…¨éƒ¨æŒ‰é’®äº‹ä»¶
                    dialogContent.querySelector('#delete-all-btn').addEventListener('click', function() {
                        // å…¨éƒ¨åˆ é™¤ï¼ˆå½»åº•åˆ é™¤å‘¨æœŸäº‹é¡¹ï¼‰
                        // å¦‚æœoriginalIdæœ‰æ•ˆï¼Œç›´æ¥åˆ é™¤å‘¨æœŸäº‹é¡¹ï¼›å¦åˆ™ï¼Œä½¿ç”¨todoIdä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ
                        const deleteId = originalId ? originalId : todoId;
                        fetch(`/delete/${deleteId}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                        })
                        .then(response => {
                            if (response.redirected) {
                                window.location.href = response.url + '#todo-' + todoId;
                            } else {
                                window.location.reload();
                            }
                        })
                        .catch(error => console.error('åˆ é™¤å¤±è´¥:', error));
                        
                        // ç§»é™¤å¯¹è¯æ¡†å’Œé®ç½©
                        document.body.removeChild(overlay);
                        document.body.removeChild(dialog);
                    });
                } else {
                    // éå‘¨æœŸäº‹é¡¹ï¼Œç›´æ¥åˆ é™¤
                    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¾…åŠäº‹é¡¹å—ï¼Ÿ')) {
                        fetch(`/delete/${todoId}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                        })
                        .then(response => {
                            if (response.redirected) {
                                window.location.href = response.url + '#todo-' + todoId;
                            } else {
                                window.location.reload();
                            }
                        })
                        .catch(error => console.error('åˆ é™¤å¤±è´¥:', error));
                    }
                }
            });
        });
        
        // å‘¨æœŸè®¾ç½®åŠ¨æ€äº¤äº’
        document.addEventListener('DOMContentLoaded', function() {
            // 1. å‘¨æœŸåˆ‡æ¢æ˜¾ç¤º/éšè—
            const isRecurringCheckbox = document.getElementById('is_recurring');
            const recurrenceSettings = document.querySelector('.recurrence-settings');
            
            isRecurringCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    recurrenceSettings.style.display = 'block';
                } else {
                    recurrenceSettings.style.display = 'none';
                }
            });
            
            // 2. å‘¨æœŸç±»å‹å˜åŒ–ï¼Œæ›´æ–°å•ä½
            const recurrenceTypeSelect = document.getElementById('recurrence_type');
            const intervalUnit = document.getElementById('interval-unit');
            const recurrenceDaysSection = document.querySelector('.recurrence-days-section');
            
            // å•ä½æ˜ å°„
            const unitMap = {
                'yearly': 'å¹´',
                'monthly': 'æœˆ',
                'daily': 'æ—¥',
                'hourly': 'å°æ—¶',
                'minutely': 'åˆ†é’Ÿ',
                'weekly': 'å‘¨'
            };
            
            recurrenceTypeSelect.addEventListener('change', function() {
                const selectedType = this.value;
                intervalUnit.textContent = unitMap[selectedType];
                
                // æ˜¾ç¤º/éšè—æ¯å‘¨ç‰¹å®šæ—¥é€‰æ‹©
                if (selectedType === 'weekly') {
                    recurrenceDaysSection.style.display = 'block';
                } else {
                    recurrenceDaysSection.style.display = 'none';
                }
            });
            
            // 3. è¡¨å•æäº¤å‰ï¼Œå¤„ç†æ¯å‘¨ç‰¹å®šæ—¥é€‰æ‹©
            const addForm = document.querySelector('.add-form');
            const recurrenceDaysJson = document.getElementById('recurrence_days_json');
            
            addForm.addEventListener('submit', function(e) {
                // è·å–æ‰€æœ‰é€‰ä¸­çš„æ˜ŸæœŸå‡ 
                const selectedDays = Array.from(
                    document.querySelectorAll('input[name="recurrence_days_checkbox"]:checked')
                ).map(checkbox => parseInt(checkbox.value));
                
                // è½¬æ¢ä¸ºJSONå­—ç¬¦ä¸²
                recurrenceDaysJson.value = JSON.stringify(selectedDays);
            });
            
            // åˆå§‹åŠ è½½æ—¶ï¼Œæ ¹æ®é€‰ä¸­çš„å‘¨æœŸç±»å‹æ›´æ–°UI
            const initialType = recurrenceTypeSelect.value;
            intervalUnit.textContent = unitMap[initialType];
            if (initialType !== 'weekly') {
                recurrenceDaysSection.style.display = 'none';
            }
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TodoList</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 600px;
            margin: 2rem auto;
            padding: 1.5rem;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 1.5rem;
        }
        
        .add-form {
            display: flex;
            flex-direction: column;
            margin-bottom: 1.5rem;
            gap: 0.75rem;
        }
        
        .add-form input[type="text"] {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .deadline-input {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .deadline-input label {
            font-weight: 500;
            color: #555;
        }
        
        .deadline-input input[type="datetime-local"] {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .todo-deadline {
            font-size: 0.85rem;
            color: #666;
            margin-top: 0.25rem;
        }
        
        .todo-deadline.overdue {
            color: #e74c3c;
            font-weight: 500;
        }
        
        .todo-deadline.upcoming {
            color: #f39c12;
        }
        
        .todo-deadline.normal {
            color: #27ae60;
        }
        
        .add-form button {
            padding: 0.75rem 1.5rem;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }
        
        .add-form button:hover {
            background-color: #2980b9;
        }
        
        .todo-list {
            list-style: none;
        }
        
        .todo-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            margin-bottom: 0.5rem;
            background-color: #fafafa;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .todo-item:hover {
            background-color: #f0f0f0;
        }
        
        .todo-item.completed {
            background-color: #e8f5e8;
        }
        
        .todo-item.completed .todo-title {
            text-decoration: line-through;
            color: #888;
        }
        
        .todo-checkbox {
            margin-right: 1rem;
            transform: scale(1.2);
        }
        
        .todo-title {
            flex: 1;
            font-size: 1rem;
        }
        
        .todo-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .btn-delete {
            background-color: #e74c3c;
            color: white;
        }
        
        .btn-delete:hover {
            background-color: #c0392b;
        }
        
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: #888;
            font-style: italic;
        }
        
        /* å‘¨æœŸè®¾ç½®æ ·å¼ */
        .recurrence-section {
            margin-top: 10px;
        }
        
        .recurrence-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .recurrence-row {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .recurrence-days {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 5px;
        }
        
        .recurrence-days label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }
        
        .recurrence-settings {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }
        
        /* å‘¨æœŸäº‹é¡¹åˆ—è¡¨æ˜¾ç¤º */
        .todo-item.recurring {
            border-left: 4px solid #3498db;
        }
        
        .todo-recurrence {
            font-size: 0.85rem;
            color: #666;
            margin-top: 0.25rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .todo-recurrence::before {
            content: 'ğŸ”„';
        }
        
        .todo-next-occurrence {
            font-size: 0.8rem;
            color: #27ae60;
            margin-top: 0.25rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>TodoList</h1>
        
        <form class="add-form" action="/add" method="post">
            <input type="text" name="title" placeholder="æ·»åŠ æ–°çš„å¾…åŠäº‹é¡¹..." required>
            <div class="deadline-input">
                <label for="deadline">æˆªæ­¢æ—¶é—´ï¼š</label>
                <input type="datetime-local" id="deadline" name="deadline" required>
            </div>
            
            <!-- å‘¨æœŸè®¾ç½® -->
            <div class="recurrence-section">
                <div class="recurrence-toggle">
                    <input type="checkbox" id="is_recurring" name="is_recurring">
                    <label for="is_recurring">è®¾ç½®ä¸ºå‘¨æœŸäº‹é¡¹</label>
                </div>
                
                <div class="recurrence-settings" style="display: none; margin-left: 20px; margin-top: 10px;">
                    <div class="recurrence-row">
                        <label for="recurrence_type">å‘¨æœŸç±»å‹ï¼š</label>
                        <select id="recurrence_type" name="recurrence_type">
                            <option value="yearly">æ¯nå¹´</option>
                            <option value="monthly">æ¯næœˆ</option>
                            <option value="daily">æ¯næ—¥</option>
                            <option value="hourly">æ¯nå°æ—¶</option>
                            <option value="minutely">æ¯nåˆ†é’Ÿ</option>
                            <option value="weekly" selected>æ¯å‘¨n</option>
                        </select>
                    </div>
                    
                    <div class="recurrence-row">
                        <label for="recurrence_interval">å‘¨æœŸé—´éš”ï¼š</label>
                        <input type="number" id="recurrence_interval" name="recurrence_interval" min="1" value="1">
                        <span id="interval-unit">å‘¨</span>
                    </div>
                    
                    <!-- æ¯å‘¨ç‰¹å®šæ—¥é€‰æ‹© -->
                    <div class="recurrence-days-section" style="margin-top: 10px;">
                        <label>æ¯å‘¨ç‰¹å®šæ—¥ï¼š</label>
                        <div class="recurrence-days">
                            <label><input type="checkbox" name="recurrence_days_checkbox" value="0">å‘¨ä¸€</label>
                            <label><input type="checkbox" name="recurrence_days_checkbox" value="1">å‘¨äºŒ</label>
                            <label><input type="checkbox" name="recurrence_days_checkbox" value="2">å‘¨ä¸‰</label>
                            <label><input type="checkbox" name="recurrence_days_checkbox" value="3">å‘¨å››</label>
                            <label><input type="checkbox" name="recurrence_days_checkbox" value="4">å‘¨äº”</label>
                            <label><input type="checkbox" name="recurrence_days_checkbox" value="5">å‘¨å…­</label>
                            <label><input type="checkbox" name="recurrence_days_checkbox" value="6">å‘¨æ—¥</label>
                        </div>
                    </div>
                    
                    <!-- éšè—çš„å­—æ®µï¼Œç”¨äºå­˜å‚¨é€‰ä¸­çš„æ¯å‘¨ç‰¹å®šæ—¥ï¼ˆJSONæ ¼å¼ï¼‰ -->
                    <input type="hidden" id="recurrence_days_json" name="recurrence_days">
                </div>
            </div>
            
            <button type="submit">æ·»åŠ </button>
        </form>
        
        <ul class="todo-list">
            {% if todos %}
                {% for todo in todos %}
                <li class="todo-item {% if todo[2] %}completed{% endif %} {% if todo[4] %}recurring{% endif %}">
                    <form action="/toggle/{{ todo[0] }}" method="post" class="toggle-form" style="display: inline;">
                        <input type="checkbox" class="todo-checkbox" {% if todo[2] %}checked{% endif %}>
                    </form>
                    <div class="todo-content">
                        <span class="todo-title">{{ todo[1] }}</span>
                        <span class="todo-deadline" data-deadline="{{ todo[3] }}">
                            æˆªæ­¢æ—¶é—´ï¼š{{ todo[3] }}
                        </span>
                        
                        <!-- æ˜¾ç¤ºå‘¨æœŸä¿¡æ¯ -->
                        {% if todo[4] %}
                        <span class="todo-recurrence">
                            {{ 'æ¯' }}{{ todo[6] }}{% if todo[5] == 'yearly' %}å¹´{% elif todo[5] == 'monthly' %}æœˆ{% elif todo[5] == 'daily' %}æ—¥{% elif todo[5] == 'hourly' %}å°æ—¶{% elif todo[5] == 'minutely' %}åˆ†é’Ÿ{% elif todo[5] == 'weekly' %}å‘¨{% endif %}{% if todo[5] == 'weekly' and todo[7] %}{% set days = todo[7]|fromjson %}{% if days %}{% for day in days %}{% if day == 0 %}ä¸€{% elif day == 1 %}äºŒ{% elif day == 2 %}ä¸‰{% elif day == 3 %}å››{% elif day == 4 %}äº”{% elif day == 5 %}å…­{% elif day == 6 %}æ—¥{% endif %}{% endfor %}{% endif %}{% endif %}
                        </span>
                        {% if todo[8] %}
                        <span class="todo-next-occurrence">
                            ä¸‹æ¬¡ï¼š{{ todo[8] }}
                        </span>
                        {% endif %}
                        {% endif %}
                    </div>
                    <div class="todo-actions">
                        <form action="/delete/{{ todo[0] }}" method="post" style="display: inline;">
                            <button type="submit" class="btn btn-delete">åˆ é™¤</button>
                        </form>
                    </div>
                </li>
                {% endfor %}
            {% else %}
                <li class="empty-state">è¿˜æ²¡æœ‰å¾…åŠäº‹é¡¹ï¼Œæ·»åŠ ä¸€ä¸ªå§ï¼</li>
            {% endif %}
        </ul>
    </div>
    
    <script>
        // è®¾ç½®é»˜è®¤æˆªæ­¢æ—¶é—´ä¸ºå½“å‰æ—¶é—´+24å°æ—¶
        document.addEventListener('DOMContentLoaded', function() {
            // è®¡ç®—24å°æ—¶åçš„æ—¶é—´
            const now = new Date();
            const tomorrow = new Date(now.getTime() + 24 * 60 * 60 * 1000);
            
            // æ ¼å¼åŒ–æ—¶é—´ä¸ºYYYY-MM-DDTHH:MMæ ¼å¼
            const year = tomorrow.getFullYear();
            const month = String(tomorrow.getMonth() + 1).padStart(2, '0');
            const day = String(tomorrow.getDate()).padStart(2, '0');
            const hours = String(tomorrow.getHours()).padStart(2, '0');
            const minutes = String(tomorrow.getMinutes()).padStart(2, '0');
            
            const formattedDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;
            
            // è®¾ç½®é»˜è®¤å€¼
            const deadlineInput = document.getElementById('deadline');
            if (deadlineInput) {
                deadlineInput.value = formattedDateTime;
            }
            
            // æ›´æ–°deadlineçŠ¶æ€æ ·å¼
            updateDeadlineStatus();
        });
        
        // æ›´æ–°æ‰€æœ‰deadlineçŠ¶æ€æ ·å¼
        function updateDeadlineStatus() {
            const now = new Date();
            const deadlines = document.querySelectorAll('.todo-deadline');
            
            deadlines.forEach(deadlineEl => {
                const deadlineStr = deadlineEl.getAttribute('data-deadline');
                if (deadlineStr) {
                    const deadline = new Date(deadlineStr);
                    const diff = deadline - now;
                    
                    // ç§»é™¤æ‰€æœ‰çŠ¶æ€ç±»
                    deadlineEl.classList.remove('overdue', 'upcoming', 'normal');
                    
                    // æ·»åŠ çŠ¶æ€ç±»
                    if (diff < 0) {
                        deadlineEl.classList.add('overdue');
                        deadlineEl.textContent = `æˆªæ­¢æ—¶é—´ï¼š${deadlineStr} (å·²è¿‡æœŸ)`;
                    } else if (diff < 24 * 60 * 60 * 1000) {
                        deadlineEl.classList.add('upcoming');
                        deadlineEl.textContent = `æˆªæ­¢æ—¶é—´ï¼š${deadlineStr} (å³å°†è¿‡æœŸ)`;
                    } else {
                        deadlineEl.classList.add('normal');
                        deadlineEl.textContent = `æˆªæ­¢æ—¶é—´ï¼š${deadlineStr}`;
                    }
                }
            });
        }
        
        // ä¸ºå¤é€‰æ¡†æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œæäº¤çˆ¶çº§è¡¨å•
        document.querySelectorAll('.todo-checkbox').forEach(checkbox => {
            checkbox.addEventListener('click', function(e) {
                // é˜»æ­¢å¤é€‰æ¡†çš„é»˜è®¤è¡Œä¸º
                e.preventDefault();
                // è·å–çˆ¶çº§è¡¨å•å¹¶æäº¤
                const form = this.closest('.toggle-form');
                if (form) {
                    form.submit();
                }
            });
        });
        
        // ä¸ºåˆ é™¤æŒ‰é’®æ·»åŠ ç¡®è®¤æç¤º
        document.querySelectorAll('.btn-delete').forEach(button => {
            button.addEventListener('click', function(e) {
                if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¾…åŠäº‹é¡¹å—ï¼Ÿ')) {
                    e.preventDefault();
                }
            });
        });
        
        // å‘¨æœŸè®¾ç½®åŠ¨æ€äº¤äº’
        document.addEventListener('DOMContentLoaded', function() {
            // 1. å‘¨æœŸåˆ‡æ¢æ˜¾ç¤º/éšè—
            const isRecurringCheckbox = document.getElementById('is_recurring');
            const recurrenceSettings = document.querySelector('.recurrence-settings');
            
            isRecurringCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    recurrenceSettings.style.display = 'block';
                } else {
                    recurrenceSettings.style.display = 'none';
                }
            });
            
            // 2. å‘¨æœŸç±»å‹å˜åŒ–ï¼Œæ›´æ–°å•ä½
            const recurrenceTypeSelect = document.getElementById('recurrence_type');
            const intervalUnit = document.getElementById('interval-unit');
            const recurrenceDaysSection = document.querySelector('.recurrence-days-section');
            
            // å•ä½æ˜ å°„
            const unitMap = {
                'yearly': 'å¹´',
                'monthly': 'æœˆ',
                'daily': 'æ—¥',
                'hourly': 'å°æ—¶',
                'minutely': 'åˆ†é’Ÿ',
                'weekly': 'å‘¨'
            };
            
            recurrenceTypeSelect.addEventListener('change', function() {
                const selectedType = this.value;
                intervalUnit.textContent = unitMap[selectedType];
                
                // æ˜¾ç¤º/éšè—æ¯å‘¨ç‰¹å®šæ—¥é€‰æ‹©
                if (selectedType === 'weekly') {
                    recurrenceDaysSection.style.display = 'block';
                } else {
                    recurrenceDaysSection.style.display = 'none';
                }
            });
            
            // 3. è¡¨å•æäº¤å‰ï¼Œå¤„ç†æ¯å‘¨ç‰¹å®šæ—¥é€‰æ‹©
            const addForm = document.querySelector('.add-form');
            const recurrenceDaysJson = document.getElementById('recurrence_days_json');
            
            addForm.addEventListener('submit', function(e) {
                // è·å–æ‰€æœ‰é€‰ä¸­çš„æ˜ŸæœŸå‡ 
                const selectedDays = Array.from(
                    document.querySelectorAll('input[name="recurrence_days_checkbox"]:checked')
                ).map(checkbox => parseInt(checkbox.value));
                
                // è½¬æ¢ä¸ºJSONå­—ç¬¦ä¸²
                recurrenceDaysJson.value = JSON.stringify(selectedDays);
            });
            
            // åˆå§‹åŠ è½½æ—¶ï¼Œæ ¹æ®é€‰ä¸­çš„å‘¨æœŸç±»å‹æ›´æ–°UI
            const initialType = recurrenceTypeSelect.value;
            intervalUnit.textContent = unitMap[initialType];
            if (initialType !== 'weekly') {
                recurrenceDaysSection.style.display = 'none';
            }
        });
    </script>
</body>
</html>
